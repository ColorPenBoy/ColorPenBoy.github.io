<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Swift踩坑日记（一） | 彩笔</title><meta name="description"><meta name="generator" content="彩笔"><meta name="author" content="Color Pen"><meta name="keywords"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1><a href="/" alt="彩笔" title="彩笔" itemprop="headline">彩笔</a></h1><p itemprop="description">眼中阅尽繁华，心中鲜衣怒马</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/ " alt="home" title="home" itemprop="url">home</a></li><li itemprop="name"><a href="/articles" alt="articles" title="articles" itemprop="url">articles</a></li><li itemprop="name"><a href="/author" alt="author" title="author" itemprop="url">author</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline" class="post-heading">Swift踩坑日记（一）</h1><span class="post-meta"></span><br><br><h1 id="Swift踩坑日记（一）"><a href="#Swift踩坑日记（一）" class="headerlink" title="Swift踩坑日记（一）"></a>Swift踩坑日记（一）</h1><p>swift是一门支持多范式编程的强大编程语言，从传统的OOP到FRP、POP等都可以兼容并包。切换swift以来，从原来的Objective-C Style 人肉翻译，到现在的 Swift Style乐趣无穷，中间踩了不少坑，一点点记录下来，也是对自己的总结提高。 </p>
<h2 id="废话不多说，直接上需求："><a href="#废话不多说，直接上需求：" class="headerlink" title="废话不多说，直接上需求："></a>废话不多说，直接上需求：</h2><p>在中国地图上根据每个省的销售量多少，显示对应的深浅颜色（可以理解为降雨量分布）。废话不多说，先上效果图。</p>
<p><img src="/images/swift/chinaprovince.png" alt="中国省份地图"></p>
<h4 id="首先实现指示条颜色渐变"><a href="#首先实现指示条颜色渐变" class="headerlink" title="首先实现指示条颜色渐变"></a>首先实现指示条颜色渐变</h4><p>（P.S. 先解决边边角角的小问题）</p>
<p>销量高对应颜色<br> <code>UIColor(red: 66.0/255.0, green: 152.0/255.0, blue: 230.0/255.0, alpha: 1.0)</code></p>
<p>销量低对应颜色<br> <code>UIColor(red: 218.0/255.0, green: 251.0/255.0, blue: 254.0/255.0, alpha: 1.0)</code></p>
<p>使用CoreAnimation中的CAGradientLayer即可解决问题。</p>
<p>封装一个View如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HxHGradientView</span> : <span class="title">UIView</span> </span>&#123;</span><br><span class="line">   	<span class="keyword">lazy</span> <span class="keyword">var</span> gradientLayer : <span class="type">CAGradientLayer</span> <span class="operator">=</span> &#123;</span><br><span class="line">       	<span class="keyword">let</span> lowColor <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="number">218.0</span><span class="operator">/</span><span class="number">255.0</span>, green: <span class="number">251.0</span><span class="operator">/</span><span class="number">255.0</span>, blue: <span class="number">254.0</span><span class="operator">/</span><span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">       	<span class="keyword">let</span> highColor <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="number">66.0</span><span class="operator">/</span><span class="number">255.0</span>, green: <span class="number">152.0</span><span class="operator">/</span><span class="number">255.0</span>, blue: <span class="number">230.0</span><span class="operator">/</span><span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">       	<span class="variable">$0</span>.colors <span class="operator">=</span> [lowColor.<span class="type">CGColor</span>, highColor.<span class="type">CGColor</span>]</span><br><span class="line">       	<span class="variable">$0</span>.endPoint <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0.5</span>, y: <span class="number">0</span>)</span><br><span class="line">       	<span class="variable">$0</span>.startPoint <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0.5</span>, y: <span class="number">1</span>)</span><br><span class="line">       	<span class="keyword">return</span> <span class="variable">$0</span></span><br><span class="line">   	&#125;(<span class="type">CAGradientLayer</span>())</span><br><span class="line">   </span><br><span class="line">   	<span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSublayersOfLayer</span>(<span class="params">layer</span>: <span class="type">CALayer</span>)</span> &#123;</span><br><span class="line">      		<span class="keyword">super</span>.layoutSublayersOfLayer(layer)</span><br><span class="line">       		<span class="keyword">self</span>.gradientLayer.frame <span class="operator">=</span> <span class="keyword">self</span>.bounds</span><br><span class="line">       		<span class="keyword">self</span>.layer.addSublayer(<span class="keyword">self</span>.gradientLayer)</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有关CAGradientLayer在Appcoda有篇<a target="_blank" rel="noopener" href="http://www.appcoda.com/cagradientlayer/">文章</a>说的非常详细，不再赘述。</p>
<h2 id="SVG绘制不规则图形问题"><a href="#SVG绘制不规则图形问题" class="headerlink" title="SVG绘制不规则图形问题"></a>SVG绘制不规则图形问题</h2><p>SVG图片打开其实就是XML文件，所以SVG绘图，其实就是将XML文件里面的坐标读出，然后根据区域画图渲染的过程，Gayhub上已经有一些比较优秀的轮子了，不在赘述，<a target="_blank" rel="noopener" href="https://github.com/ColorPenBoy/FSInteractiveMap">这是我使用的比较简单易懂的轮子</a></p>
<h2 id="销量转换颜色问题"><a href="#销量转换颜色问题" class="headerlink" title="销量转换颜色问题"></a>销量转换颜色问题</h2><p>下面进入本篇文章的重点，如何优化销量转换为颜色算法。</p>
<ul>
<li>服务端返回的销量数据，结构如下：</li>
</ul>
<p><img src="/images/swift/sales.png"></p>
<ul>
<li>根据结构，我们定义两个struct来装载数据：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ChinaMapNumberModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 销量 */</span></span><br><span class="line">    <span class="keyword">var</span> num: <span class="type">Int</span></span><br><span class="line">    <span class="comment">/** 省份 */</span></span><br><span class="line">    <span class="keyword">var</span> proname: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ChinaMapColorModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 颜色 */</span></span><br><span class="line">    <span class="keyword">var</span> color: <span class="type">UIColor</span></span><br><span class="line">    <span class="comment">/** 省份 */</span></span><br><span class="line">    <span class="keyword">var</span> proname: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>数据解析</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">jsonConvertToModelArray</span>(<span class="params">dict</span>: [<span class="params">String</span>: <span class="type">AnyObject</span>])</span> -&gt; [<span class="type">ChinaMapNumberModel</span>] &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> results <span class="operator">=</span> dict[<span class="string">&quot;Result&quot;</span>] <span class="keyword">as?</span> [[<span class="type">String</span>: <span class="type">AnyObject</span>]] <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results.flatMap(&#123; (item: [String: <span class="type">AnyObject</span>]) -&gt; <span class="type">ChinaMapNumberModel</span>? <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> numStr <span class="operator">=</span> item[<span class="string">&quot;num&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span>, <span class="keyword">let</span> pronameStr <span class="operator">=</span> item[<span class="string">&quot;proname&quot;</span>] <span class="keyword">as?</span> <span class="type">String</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ChinaMapNumberModel</span>(num: <span class="type">Int</span>(numStr)<span class="operator">!</span>, proname: pronameStr)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解析以后，我们得到全国各省份销量的数据源数组；那怎么转换成全国各省份颜色数据源数组呢？</p>
<ul>
<li>下面定义一个 “全国各省份销量数据源” 转换成 “全国各省份颜色数据源”的函数</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">privinceNumberConvertColor</span>(<span class="params">numberArray</span>: [<span class="type">ChinaMapNumberModel</span>])</span> -&gt; ([<span class="type">ChinaMapColorModel</span>]) &#123;</span><br><span class="line">	<span class="comment">// ...这里是具体实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，我们对数据源数组进行排序，取出最大销量（MaxSales）及最小销量（MinSales）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">privinceNumberConvertColor</span>(<span class="params">numberArray</span>: [<span class="type">ChinaMapNumberModel</span>])</span> -&gt; ([<span class="type">ChinaMapColorModel</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">guard</span> numberArray.count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> [] &#125;      </span><br><span class="line">    <span class="keyword">let</span> convertion : (<span class="type">ChinaMapNumberModel</span>) -&gt; <span class="type">Int</span> <span class="operator">=</span> &#123; (item) -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> item.num</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从小到大排序</span></span><br><span class="line">    <span class="keyword">var</span> numIntArray <span class="operator">=</span> numberArray.map(convertion)</span><br><span class="line">    numIntArray.sortInPlace()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 车源数量最大值 - 车源数量最小值</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> minNum <span class="operator">=</span> numIntArray.first, <span class="keyword">let</span> maxNum <span class="operator">=</span> numIntArray.last <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...转换</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其次，颜色是R、G、B、A通道组成，Alpha通道参数固定为1.0，可以不用理会。这样，销量（Int 类型）想要转换为颜色（UIColor 类型），我们就要找到 “销量” 分别与”Red”、”Green”、”Blue”三个颜色参数的对应关系。</p>
<p><img src="/images/swift/relationshipExcel.png" alt="销量与颜色参数的关系"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> highColor <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="number">66.0</span><span class="operator">/</span><span class="number">255.0</span>, green: <span class="number">152.0</span><span class="operator">/</span><span class="number">255.0</span>, blue: <span class="number">230.0</span><span class="operator">/</span><span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line"><span class="keyword">let</span> lowColor <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="number">218.0</span><span class="operator">/</span><span class="number">255.0</span>, green: <span class="number">251.0</span><span class="operator">/</span><span class="number">255.0</span>, blue: <span class="number">254.0</span><span class="operator">/</span><span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>

<p>由上面两个颜色我们可以确定R、G、B的最大值与最小值：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> <span class="type">MinRed</span>   : <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">218.0</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">MaxRed</span>   : <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">66.0</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">MinGreen</span> : <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">251.0</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">MaxGreen</span> : <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">152.0</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">MinBlue</span>  : <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">254.0</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">let</span> <span class="type">MaxBlue</span>  : <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">230.0</span></span><br></pre></td></tr></table></figure>

<p>设置一个变量 <code>CurrentSales: Int</code> 为 当前省份销量，与之对应的颜色为 <code>CurrentColor: UIColor</code>，它的组成为：<br><code>UIColor(red: currentRed/255.0, green: currentGreen/255.0, blue: currentBlue/255.0, alpha: 1.0)</code></p>
<p>这样，我们求出 <code>CurrentRed </code>、<code>CurrentGreen </code>、<code>CurrentBlue </code>即可求出销量对应的颜色。</p>
<p>根据上图的对应关系，我们得到这样的转换代码:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CurrentRed</span> <span class="operator">=</span> <span class="type">MinRed</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxRed</span> <span class="operator">-</span> <span class="type">MinRed</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line"><span class="type">CurrentGreen</span> <span class="operator">=</span> <span class="type">MinGreen</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxGreen</span> <span class="operator">-</span> <span class="type">MinGreen</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line"><span class="type">CurrentBlue</span> <span class="operator">=</span> <span class="type">MinBlue</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxBlue</span> <span class="operator">-</span> <span class="type">MinBlue</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br></pre></td></tr></table></figure>

<p>然后让我们完成最后的转换：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">privinceNumberConvertColor</span>(<span class="params">numberArray</span>: [<span class="type">ChinaMapNumberModel</span>])</span> -&gt; ([<span class="type">ChinaMapColorModel</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">guard</span> numberArray.count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> [] &#125;      </span><br><span class="line">    <span class="keyword">let</span> convertion : (<span class="type">ChinaMapNumberModel</span>) -&gt; <span class="type">Int</span> <span class="operator">=</span> &#123; (item) -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> item.num</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从小到大排序</span></span><br><span class="line">    <span class="keyword">var</span> numIntArray <span class="operator">=</span> numberArray.map(convertion)</span><br><span class="line">    numIntArray.sortInPlace()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 车源数量最大值 - 车源数量最小值</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> minNum <span class="operator">=</span> numIntArray.first, <span class="keyword">let</span> maxNum <span class="operator">=</span> numIntArray.last <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> numberArray.map(&#123; (item) -&gt; <span class="type">ChinaMapColorModel</span> <span class="keyword">in</span></span><br><span class="line">		<span class="keyword">let</span> <span class="type">CurrentSales</span> <span class="operator">=</span> item.num</span><br><span class="line">        <span class="keyword">let</span> <span class="type">CurrentRed</span> <span class="operator">=</span> <span class="type">MinRed</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxRed</span> <span class="operator">-</span> <span class="type">MinRed</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line">		<span class="keyword">let</span> <span class="type">CurrentGreen</span> <span class="operator">=</span> <span class="type">MinGreen</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxGreen</span> <span class="operator">-</span> <span class="type">MinGreen</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line">		<span class="keyword">let</span> <span class="type">CurrentBlue</span> <span class="operator">=</span> <span class="type">MinBlue</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxBlue</span> <span class="operator">-</span> <span class="type">MinBlue</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">let</span> color <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="type">CurrentRed</span><span class="operator">/</span><span class="number">255.0</span>, green: <span class="type">CurrentGreen</span><span class="operator">/</span><span class="number">255.0</span>, blue: <span class="type">CurrentBlue</span><span class="operator">/</span><span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="type">ChinaMapColorModel</span>(color: color, proname: <span class="keyword">self</span>.provinceDict[item.proname]<span class="operator">!</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，销量转换颜色成功，但是，，，说了半天，高大上的Currying呢？</p>
<p>下面就有用到，我们来简单的用函数式的思想打量一下我们的代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="type">CurrentRed</span>   <span class="operator">=</span> <span class="type">MinRed</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxRed</span> <span class="operator">-</span> <span class="type">MinRed</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="type">CurrentGreen</span> <span class="operator">=</span> <span class="type">MinGreen</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxGreen</span> <span class="operator">-</span> <span class="type">MinGreen</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="type">CurrentBlue</span>  <span class="operator">=</span> <span class="type">MinBlue</span> <span class="operator">+</span> (<span class="type">CurrentSales</span> <span class="operator">-</span> <span class="type">MinSales</span>) <span class="operator">*</span> (<span class="type">MaxBlue</span> <span class="operator">-</span> <span class="type">MinBlue</span>)<span class="operator">/</span>(<span class="type">MaxSales</span> <span class="operator">-</span> <span class="type">MinSales</span>)</span><br></pre></td></tr></table></figure>

<p>非常容易的看到，其实Red、Green、Blue都是用的同一个公式。那么，我们将公式抽出：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">numConvertColor</span>(<span class="params">minNum</span> : <span class="type">Int</span>, <span class="params">maxNum</span>: <span class="type">Int</span>, <span class="params">currentNum</span>: <span class="type">Int</span>, <span class="params">minColor</span>: <span class="type">CGFloat</span>, <span class="params">maxColor</span>: <span class="type">CGFloat</span>)</span> -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> minColor <span class="operator">+</span> <span class="type">CGFloat</span>(currentNum <span class="operator">-</span> minNum) <span class="operator">*</span> (maxColor <span class="operator">-</span> minColor)<span class="operator">/</span><span class="type">CGFloat</span>(maxNum <span class="operator">-</span> minNum)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，上面的3句类似的代码，就可以修改成如下代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="type">CurrentRed</span>   <span class="operator">=</span> numConvertColor(minNum, maxNum: maxNum, currentNum: item.num, minColor: <span class="type">MinRed</span>, maxColor: <span class="type">MaxRed</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="type">CurrentGreen</span> <span class="operator">=</span> numConvertColor(minNum, maxNum: maxNum, currentNum: item.num, minColor: <span class="type">MinGreen</span>, maxColor: <span class="type">MaxGreen</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="type">CurrentBlue</span>  <span class="operator">=</span> numConvertColor(minNum, maxNum: maxNum, currentNum: item.num, minColor: <span class="type">MinBlue</span>, maxColor: <span class="type">MaxBlue</span>)</span><br></pre></td></tr></table></figure>

<p>现在看起来好一些。但是，，，还没完</p>
<h3 id="函数式编程–Swift中Currying的一次小实践"><a href="#函数式编程–Swift中Currying的一次小实践" class="headerlink" title="函数式编程–Swift中Currying的一次小实践"></a>函数式编程–Swift中Currying的一次小实践</h3><p>我们看到，前面3个参数，都是一模一样的，我们还是一样，重复写了3次，如果你说，3次不多还好啊，那300次呢，3000次呢？用到了一个神奇的东西Currying。</p>
<p>这里不再赘述“函数式编程（Functional Programming）”、“柯里化（currying）”等概念，如果对基本概念还不了解，请参考以下文章学习。</p>
<ul>
<li><a href="atswift.io">中国第一届Swift开发者大会</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cocoachina.com/swift/20150106/10843.html">Swift 的函数式编程</a></li>
</ul>
<p>刚刚接触swift的时候，了解到了currying的概念，但是由于比较菜，一直不知道在哪里应用。最近项目中遇到了一个需求，终于使用上了currying，记录一下。</p>
<p>通俗的说，一个函数，有5个参数，有3个是公用的，那么，可以先传入这3个参数，输出一个新的函数，再利用这个新的函数，分别传入剩下的2个各不相同的参数。</p>
<p>最后，完整的代码如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">privinceNumberConvertColor</span>(<span class="params">numberArray</span>: [<span class="type">ChinaMapNumberModel</span>])</span> -&gt; ([<span class="type">ChinaMapColorModel</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">guard</span> numberArray.count <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> [] &#125;      </span><br><span class="line">    <span class="keyword">let</span> convertion : (<span class="type">ChinaMapNumberModel</span>) -&gt; <span class="type">Int</span> <span class="operator">=</span> &#123; (item) -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> item.num</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从小到大排序</span></span><br><span class="line">    <span class="keyword">var</span> numIntArray <span class="operator">=</span> numberArray.map(convertion)</span><br><span class="line">    numIntArray.sortInPlace()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 车源数量最大值 - 车源数量最小值</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> minNum <span class="operator">=</span> numIntArray.first, <span class="keyword">let</span> maxNum <span class="operator">=</span> numIntArray.last <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> numberArray.map(&#123; (item) -&gt; <span class="type">ChinaMapColorModel</span> <span class="keyword">in</span></span><br><span class="line">		<span class="keyword">let</span> <span class="type">CurrentSales</span> <span class="operator">=</span> item.num</span><br><span class="line">        <span class="keyword">let</span> function <span class="operator">=</span> numConvertColor(<span class="type">MinSales</span>, maxNum: <span class="type">MaxSales</span>, currentNum: <span class="type">CurrentSales</span>)</span><br><span class="line">        <span class="keyword">let</span> <span class="type">CurrentRed</span>   <span class="operator">=</span> function(minColor: <span class="type">MinRed</span>, maxColor: <span class="type">MaxRed</span>)</span><br><span class="line">        <span class="keyword">let</span> <span class="type">CurrentGreen</span> <span class="operator">=</span> function(minColor: <span class="type">MinGreen</span>, maxColor: <span class="type">MaxGreen</span>)</span><br><span class="line">        <span class="keyword">let</span> <span class="type">CurrentBlue</span>  <span class="operator">=</span> function(minColor: <span class="type">MinBlue</span>, maxColor: <span class="type">MaxBlue</span>)    </span><br><span class="line">        <span class="keyword">let</span> color <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="type">CurrentRed</span><span class="operator">/</span><span class="number">255.0</span>, green: <span class="type">CurrentGreen</span><span class="operator">/</span><span class="number">255.0</span>, blue: <span class="type">CurrentBlue</span><span class="operator">/</span><span class="number">255.0</span>, alpha: <span class="number">1.0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ChinaMapColorModel</span>(color: color, proname: <span class="keyword">self</span>.provinceDict[item.proname]<span class="operator">!</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">numConvertColor</span>(<span class="params">minNum</span> : <span class="type">Int</span>, <span class="params">maxNum</span>: <span class="type">Int</span>, <span class="params">currentNum</span>: <span class="type">Int</span>)</span> -&gt; (minColor: <span class="type">CGFloat</span>, maxColor: <span class="type">CGFloat</span>) -&gt; <span class="type">CGFloat</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &#123; minColor, maxColor <span class="keyword">in</span></span><br><span class="line">    	<span class="keyword">return</span> minColor <span class="operator">+</span> <span class="type">CGFloat</span>(currentNum <span class="operator">-</span> minNum) <span class="operator">*</span> (maxColor <span class="operator">-</span> minColor)<span class="operator">/</span><span class="type">CGFloat</span>(maxNum <span class="operator">-</span> minNum)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</article><br><br><span class="next-post"><a href="/2016/11/20/2016-11-20-ios-protocol-dispatcher/" itemprop="url">Older Post ⇒</a></span><span class="prev-post"><a href="/2016/12/19/2016-12-19-xcodebuild_introduce/" itemprop="url">⇐ Next Post </a></span><br><br><br></main></body></html>